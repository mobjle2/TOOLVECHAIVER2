<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tool Ve Chai V2</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:Arial}
.container{max-width:700px;margin:auto;padding:20px}
.card{
background:#1a1a1a;
padding:16px;
border-radius:14px;
margin-top:15px;
border:1px solid #2a2a2a;
}
.row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
button{
padding:8px 14px;
border-radius:10px;
border:none;
cursor:pointer;
font-weight:bold;
}
.green{background:#16a34a;color:white}
.orange{background:#f59e0b;color:white}
.red{background:#ef4444;color:white}
.primary{background:#2563eb;color:white;width:100%;margin-top:10px}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:bold}
.open{background:#059669}
.lock{background:#dc2626}
#loginScreen{
position:fixed;top:0;left:0;width:100%;height:100%;
background:black;display:flex;justify-content:center;align-items:center;
z-index:9999;
}
.login-box{
width:320px;background:#111;padding:30px;
border-radius:18px;border:1px solid gold;
}
input{
width:100%;padding:12px;margin-top:10px;
border-radius:10px;border:1px solid #333;background:#111;color:white;
}
hr{border:1px solid #333;margin:30px 0}
</style>
</head>

<body>

<div id="loginScreen">
<div class="login-box">
<h3 style="text-align:center;color:gold">Admin V2</h3>
<input id="loginEmail" placeholder="Gmail">
<input id="loginPass" type="password" placeholder="Password">
<button class="primary" onclick="login()">LOGIN</button>
<div id="loginError" style="color:red;text-align:center;margin-top:8px"></div>
</div>
</div>

<div class="container">
<h2>ğŸ”— Quáº£n lÃ½ Share Link V2</h2>
<button class="green" onclick="createLink()">+ Táº¡o link má»›i</button>
<div id="linksBox"></div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyCEL7BDXvmNi2dp1VNpua7b2plpTiTOK3U",
authDomain:"toolvechai.firebaseapp.com",
projectId:"toolvechai",
storageBucket:"toolvechai.firebasestorage.app",
messagingSenderId:"947125032083",
appId:"1:947125032083:web:a7335aa5fd446a44446966"
}
firebase.initializeApp(firebaseConfig)
const auth=firebase.auth()
const db=firebase.firestore()

const linksRef=db.collection("ToolVeChaiV2_links")

/* ===== LOGIN ===== */
function login(){
const email=loginEmail.value.trim()
const pass=loginPass.value.trim()

auth.signInWithEmailAndPassword(email,pass)
.then(async()=>{
const doc=await db.collection("users").doc(email).get()
if(!doc.exists||doc.data().role!=="admin_v2"){
await auth.signOut()
loginError.innerText="KhÃ´ng cÃ³ quyá»n!"
return
}
loginScreen.style.display="none"
})
.catch(()=>loginError.innerText="Sai Gmail hoáº·c Password!")
}

/* ===== LINK VIEW MODE (KHÃ”NG ADMIN) ===== */
const params=new URLSearchParams(location.search)
const linkParam=params.get("link")

if(linkParam){
loginScreen.remove()
linksRef.doc(linkParam).get().then(doc=>{
if(!doc.exists){
document.body.innerHTML="<h2 style='color:red;text-align:center;margin-top:100px'>ğŸš« Link khÃ´ng tá»“n táº¡i</h2>"
return
}
const data=doc.data()
const expired=data.expireAt&&data.expireAt.toDate()<new Date()
if(!data.isActive||expired){
document.body.innerHTML="<h2 style='color:red;text-align:center;margin-top:100px'>ğŸš« Link Ä‘Ã£ khÃ³a</h2>"
}else{
document.body.innerHTML="<h2 style='color:lime;text-align:center;margin-top:100px'>âœ… Link há»£p lá»‡</h2>"
}
})
}

/* ===== ADMIN RENDER ===== */
auth.onAuthStateChanged(user=>{
if(!user) return

linksRef.orderBy("createdAt","desc").onSnapshot(snapshot=>{
render(snapshot.docs)
})
})

function render(docs){
const box=document.getElementById("linksBox")
box.innerHTML=""

docs.forEach(d=>{
const data=d.data()
const id=d.id
const expired=data.expireAt&&data.expireAt.toDate()<new Date()
const active=data.isActive&&!expired

box.innerHTML+=`
<div class="card">
<b>ID:</b> ${id}<br>
<span class="badge ${active?"open":"lock"}">
${active?"ğŸŸ¢ ÄANG Má»":"ğŸ”´ ÄÃƒ KHÃ“A"}
</span>
<div class="row">
<button class="green" onclick="copyLink('${id}')">Copy</button>
<button class="orange" onclick="resetLink('${id}')">Reset</button>
<button class="red" onclick="deleteLink('${id}')">XÃ³a</button>
</div>
</div>
`
})
}

/* ===== ACTIONS ===== */
function generateId(){
return Math.random().toString(36).substring(2,8)
}

async function createLink(){
const id=generateId()
const expire=new Date(Date.now()+3600000)

await linksRef.doc(id).set({
createdAt:firebase.firestore.FieldValue.serverTimestamp(),
expireAt:expire,
isActive:true
})
}

async function deleteLink(id){
await linksRef.doc(id).delete()
}

async function resetLink(id){
const expire=new Date(Date.now()+3600000)
await linksRef.doc(id).update({
expireAt:expire,
isActive:true
})
}

function copyLink(id){
const url=location.origin+location.pathname+"?link="+id
navigator.clipboard.writeText(url).then(()=>{
alert("ÄÃ£ copy link")
})
}
</script>
</body>
</html>
