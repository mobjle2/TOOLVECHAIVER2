<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tool Ve Chai V2</title>
<link rel="icon" href="data:,">

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:white}
.wrapper{max-width:1000px;margin:auto;padding:40px 20px}
input{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#111827;color:white;margin-bottom:10px}
button{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.hidden{display:none}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.card{background:#111827;padding:15px;border-radius:10px}
.badge{padding:5px 10px;border-radius:20px;font-size:12px}
.open{background:#16a34a}
.closed{background:#dc2626}
</style>
</head>
<body>

<div id="loginBox" style="max-width:400px;margin:100px auto;">
<h2>Đăng nhập</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">ĐĂNG NHẬP</button>
<div id="loginError" style="color:red;margin-top:10px"></div>
</div>

<div id="mainApp" class="wrapper hidden">

<h1>Tool Ve Chai V2</h1>

<input id="codeInput" placeholder="Nhập mã...">
<button onclick="checkCode()">CHECK</button>
<button onclick="logout()">Đăng xuất</button>

<div id="checkResult" style="margin-top:15px;"></div>

<div id="adminSection" class="hidden">
<hr>
<h2>Quản lý Link</h2>
<button onclick="createLink()">+ Tạo Link</button>
<button onclick="importCodes()" style="background:#f59e0b;margin-left:10px;">
  IMPORT ALL CODES
</button>

<div class="grid" id="linkGrid"></div>
</div>

</div>
<script src="data.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
async function importCodes(){
  const user = auth.currentUser;

  if(!user){
    alert("Bạn chưa đăng nhập");
    return;
  }

  const userDoc = await db.collection("users").doc(user.email).get();

  if(!userDoc.exists || userDoc.data().role !== "admin"){
    alert("Bạn không có quyền import");
    return;
  }

  if(!confirm("Import toàn bộ codes lên Firestore?")) return;

  for(const item of data){
    await db.collection("codes").doc(item.code).set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      used: false,
      usedBy: null,
      usedAt: null,
      mmc: item.mmc || null,
      vip: item.vip || null
    });
  }

  alert("Import hoàn tất!");
}

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const loginBox = document.getElementById("loginBox");
const mainApp = document.getElementById("mainApp");
const adminSection = document.getElementById("adminSection");
const loginError = document.getElementById("loginError");
const checkResult = document.getElementById("checkResult");
const linkGrid = document.getElementById("linkGrid");

/* AUTH */
auth.onAuthStateChanged(async(user)=>{
  if(user){
    loginBox.classList.add("hidden");
    mainApp.classList.remove("hidden");

    const doc = await db.collection("users").doc(user.email).get();

    if(doc.exists && doc.data().role === "admin"){
      adminSection.classList.remove("hidden");
      loadLinks();
    }else{
      adminSection.classList.add("hidden");
    }

  }else{
    loginBox.classList.remove("hidden");
    mainApp.classList.add("hidden");
  }
});

function login(){
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value.trim();

  auth.signInWithEmailAndPassword(email, pass)
  .catch(err=>{
    loginError.innerText = err.message;
  });
}

function logout(){
  auth.signOut();
}

/* CHECK CODE */
async function checkCode(){
  const code = document.getElementById("codeInput").value.trim();

  const doc = await db.collection("codes").doc(code).get();

  if(doc.exists && !doc.data().used){
    checkResult.innerHTML='<span class="badge open">Mã hợp lệ</span>';
  }else{
    checkResult.innerHTML='<span class="badge closed">Mã không hợp lệ</span>';
  }
}

/* ADMIN LINK */
function randomId(){
  return Math.random().toString(36).substring(2,8);
}

async function createLink(){
  const id = randomId();
  await db.collection("links").doc(id).set({
    isActive:true,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  loadLinks();
}

async function loadLinks(){
  const snap = await db.collection("links").get();
  linkGrid.innerHTML="";
  snap.forEach(doc=>{
    const data = doc.data();
    linkGrid.innerHTML+=`
      <div class="card">
        <b>${doc.id}</b><br>
        <span class="badge ${data.isActive?'open':'closed'}">
          ${data.isActive?'Đang mở':'Đang khóa'}
        </span>
        <br><br>
        <button onclick="toggleLink('${doc.id}',${data.isActive})">
          ${data.isActive?'Khóa':'Mở'}
        </button>
        <button onclick="deleteLink('${doc.id}')">Xóa</button>
      </div>
    `;
  });
}

async function toggleLink(id,status){
  await db.collection("links").doc(id).update({isActive:!status});
  loadLinks();
}

async function deleteLink(id){
  await db.collection("links").doc(id).delete();
  loadLinks();
}
</script>

</body>
</html>
