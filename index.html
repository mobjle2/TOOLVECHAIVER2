<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tool Ve Chai Check VIP V2</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;}
body{font-family:Arial;background:#111;color:white;margin:0;}
.container{max-width:900px;margin:auto;padding:20px;}

input{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:1px solid #333;
  background:#111;
  color:white;
  font-size:16px;
  margin-top:15px;
}

button{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:none;
  background:#2563eb;
  color:white;
  font-weight:bold;
  font-size:16px;
  margin-top:15px;
  cursor:pointer;
}

.item{background:#1a1a1a;padding:15px;border-radius:12px;margin-bottom:10px;}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  margin-top:6px;
  margin-right:6px;
}

.share-btn{
  width:auto;
  padding:8px 16px;
  font-size:14px;
  background:#16a34a;
  border-radius:8px;
  margin-top:10px;
}

.mmc-badge{background:#0ea5e9;color:white;}
.vip-7{background:#ef4444;color:white;}
</style>
</head>

<body>

<div id="loginScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;justify-content:center;align-items:center;z-index:9999;">
  <div style="width:360px;background:#111;padding:30px;border-radius:20px;border:1px solid gold;">
    <h2 style="text-align:center;color:gold;">ğŸ” Tool Ve Chai Admin V2</h2>
    <input id="loginEmail" type="email" placeholder="Nháº­p Gmail">
    <input id="loginPass" type="password" placeholder="Nháº­p Password">
    <button onclick="secureLogin()">LOGIN</button>
    <div id="loginError" style="color:red;text-align:center;margin-top:10px;"></div>
  </div>
</div>

<div class="container">

<h2>ğŸ›  Tool Ve Chai Check VIP V2</h2>

<input id="q" placeholder="Nháº­p 4 kÃ½ tá»± hoáº·c full mÃ£">
<button onclick="check()">CHECK</button>

<div id="out" style="margin-top:20px;display:grid;grid-template-columns:repeat(2,1fr);gap:15px;"></div>

<hr style="margin:40px 0;border:1px solid #333;">

<h3>ğŸ”— Quáº£n lÃ½ Share Link V2</h3>
<button id="createLinkBtn" class="share-btn">+ Táº¡o link má»›i</button>
<div id="shareLinksBox" style="margin-top:20px;"></div>

<hr style="margin:40px 0;border:1px solid #333;">

<div style="margin-top:20px;padding:15px;border-radius:12px;background:#1a1a1a;text-align:center;">
âš  Tool chá»‰ mang tÃ­nh tham kháº£o.<br>
ğŸ’³ Vietcombank | Nguyen Minh Trung<br>
STK: 9907373199
</div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEL7BDXvmNi2dp1VNpua7b2plpTiTOK3U",
  authDomain: "toolvechai.firebaseapp.com",
  projectId: "toolvechai",
  storageBucket: "toolvechai.firebasestorage.app",
  messagingSenderId: "947125032083",
  appId: "1:947125032083:web:a7335aa5fd446a44446966"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function secureLogin(){
  const email = loginEmail.value.trim();
  const pass = loginPass.value.trim();

  auth.signInWithEmailAndPassword(email, pass)
  .then(async (cred)=>{
    const doc = await db.collection("users").doc(email).get();
    if(!doc.exists || doc.data().role !== "admin_v2"){
      await auth.signOut();
      loginError.innerText="KhÃ´ng cÃ³ quyá»n!";
      return;
    }
    loginScreen.remove();
  })
  .catch(()=>loginError.innerText="Sai Gmail hoáº·c Password!");
}

/* ===== SHARE LINK SYSTEM ===== */

const linksRef = db.collection("ToolVeChaiV2_links");
const sessionsRef = db.collection("ToolVeChaiV2_sessions");

function generateLinkId(length = 8){
  const chars="abcdefghijklmnopqrstuvwxyz0123456789";
  let r="";
  for(let i=0;i<length;i++){
    r+=chars[Math.floor(Math.random()*chars.length)];
  }
  return r;
}

document.getElementById("createLinkBtn").addEventListener("click", async ()=>{
  const id=generateLinkId();
  const expire=new Date(Date.now()+60*60*1000);
  await linksRef.doc(id).set({
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    createdBy:auth.currentUser.email,
    expireAt:expire,
    isActive:true
  });
});

linksRef.orderBy("createdAt","desc").onSnapshot(snapshot=>{
  const box=document.getElementById("shareLinksBox");
  box.innerHTML="";
  snapshot.forEach(doc=>{
    const data=doc.data();
    const id=doc.id;
    sessionsRef.where("linkId","==",id)
    .onSnapshot(snap=>{
      const online=snap.size;
      const expired=data.expireAt && data.expireAt.toDate()<new Date();
      const active=data.isActive && !expired;

      box.innerHTML+=`
        <div class="item">
          <div><b>ID:</b> ${id}</div>
          <div class="badge ${active?"mmc-badge":"vip-7"}">
            ${active?"ğŸŸ¢ ÄANG Má»":"ğŸ”´ ÄÃƒ KHÃ“A"}
          </div>
          <div>ğŸ‘¥ Online: ${online}</div>
          <button class="share-btn" onclick="copyLink('${id}')">Copy</button>
          <button class="share-btn" onclick="resetLink('${id}')">Reset</button>
          <button class="share-btn" style="background:red" onclick="deleteLink('${id}')">XÃ³a</button>
        </div>
      `;
    });
  });
});

function copyLink(id){
  const url=window.location.origin+window.location.pathname+"?link="+id;
  navigator.clipboard.writeText(url);
  alert("ÄÃ£ copy link!");
}

async function resetLink(oldId){
  const oldDoc=await linksRef.doc(oldId).get();
  const data=oldDoc.data();
  const newId=generateLinkId();

  await linksRef.doc(newId).set({
    ...data,
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    isActive:true
  });

  await linksRef.doc(oldId).update({isActive:false});

  const sessions=await sessionsRef.where("linkId","==",oldId).get();
  sessions.forEach(d=>d.ref.delete());
}

async function deleteLink(id){
  await linksRef.doc(id).update({isActive:false});
  const sessions=await sessionsRef.where("linkId","==",id).get();
  sessions.forEach(d=>d.ref.delete());
}

const params=new URLSearchParams(window.location.search);
const linkId=params.get("link");

if(linkId){
  linksRef.doc(linkId).onSnapshot(doc=>{
    if(!doc.exists){
      document.body.innerHTML="<h2 style='color:red;text-align:center;margin-top:100px'>ğŸš« Link nÃ y khÃ´ng cÃ²n sá»­ dá»¥ng Ä‘Æ°á»£c</h2>";
      return;
    }
    const data=doc.data();
    const expired=data.expireAt && data.expireAt.toDate()<new Date();
    if(!data.isActive || expired){
      document.body.innerHTML="<h2 style='color:red;text-align:center;margin-top:100px'>ğŸš« Link nÃ y khÃ´ng cÃ²n sá»­ dá»¥ng Ä‘Æ°á»£c</h2>";
    }
  });
}
</script>
</body>
</html>
